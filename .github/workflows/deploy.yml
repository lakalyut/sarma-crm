name: Deploy (sarma-crm)

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            cd /home/ubuntu/sarma-crm

            git fetch --all
            git reset --hard origin/main

            # 1) Поднять db
            sudo docker compose up -d db

            # Подождать готовность Postgres
            sudo docker compose exec -T db bash -lc 'until pg_isready -U sarma -d sarma; do sleep 1; done'

            # 2) Бэкап (до миграций)
            mkdir -p backups
            sudo docker compose exec -T db pg_dump -U sarma sarma > "backups/backup_$(date +%F_%H-%M-%S).sql"

            # 3) Собрать новый web
            sudo docker compose build web

            # 4) Миграции
            sudo docker compose run --rm web alembic upgrade head

            # 5) Поднять всё
            sudo docker compose up -d --build --remove-orphans

            # 6) Проверка здоровья через nginx
            curl -fsS http://127.0.0.1/health >/dev/null

            # 7) Чистка
            sudo docker image prune -f